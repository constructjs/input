!function(){function t(){var t=construct.options.input||[],e={};t.indexOf("keys")>-1,t.indexOf("mouse")>-1,t.indexOf("touch")>-1&&i()&&(e.click="_ontouch"),t.indexOf("gamepad")>-1;var s=APP.Views.Main3D||APP.View;APP.Views.Main3D=s.extend({options:{monitor:construct.options.input},events:e,initialize:function(t){return this.on("intersect",_.bind(this.clickObject,this)),s.prototype.initialize.call(this,t)},_start:function(t){return t.projector=new THREE.Projector,s.prototype._start.call(this,t)},mousedown:function(){this.checkIntersect()},_ontouch:function(t){var e=t.originalEvent.changedTouches[0],o=e.clientX,i=e.clientY;this.params.set({mouse:{x:o,y:i}}),this.checkIntersect(),this.ontouch&&this.ontouch(t)},clickObject:function(t){console.log("clickObject:",t)},checkIntersect:function(){var t=$(this.el),e=t.offset(),i=this.params.get("mouse"),s=(i.x-e.left)/jQuery(window).width()*2-1,n=2*-((i.y-e.top)/jQuery(window).height())+1,a=.5,c=new THREE.Vector3(s,n,a),r=this.$3d.active.camera,h=o(this.$3d.objects);this.$3d.projector.unprojectVector(c,r);var u=new THREE.Raycaster(r.position,c.sub(r.position).normalize()),p=u.intersectObjects(h);if(p.length>0){var b=p[0].object.parent;this.trigger("intersect",b)}}})}function e(){var t=APP.Meshes.Player;APP.Meshes.Player=t.extend({keys:{"w a s d":"_moveKeys","up left down right":"_rotateKeys","q e":"_rollKeys","r f":"_elevateKeys",shift:"_accelerateKeys"},_start:function(e){return this.options.controls&&(this.on("update",_.bind(this._updateControls,this)),this.data.set({controls:{lon:0,lat:0}})),t.prototype._start.call(this,e)},onConnectGamepad:function(){},onDisconnectGamepad:function(){},updateGamepads:function(){var t=this.params.get("gamepads");if(t&&t[0]){var e=t[0].axes;this.state.move.left=e[0]<-.4?1:0,this.state.move.right=e[0]>.4?1:0,this.state.move.forward=e[1]<-.4?1:0,this.state.move.back=e[1]>.4?1:0,this.state.move.yawLeft=e[2]<-.4?1:0,this.state.move.yawRight=e[2]>.4?1:0,this.state.move.pitchUp=e[3]<-.4?1:0,this.state.move.pitchDown=e[3]>.4?1:0;var o=t[0].buttons;for(var i in o)if(o[i]){var s=this._buttonKey(i);this.trigger(s)}}this.updateMovementVector(),this.updateRotationVector()},_moveKeys:function(t,e){if(_.inArray("keys",this.options.monitor)){var o="keydown"==t.type,i=this._keys._moveKeys;switch(e){case i[0]:this.state.move.forward=o?1:0;break;case i[1]:this.state.move.left=o?1:0;break;case i[2]:this.state.move.back=o?1:0;break;case i[3]:this.state.move.right=o?1:0}this.updateMovementVector()}},_rotateKeys:function(t,e){if(_.inArray("keys",this.options.monitor)){var o="keydown"==t.type,i=this._keys._rotateKeys;switch(e){case i[0]:this.state.move.pitchUp=o?1:0;break;case i[1]:this.state.move.yawLeft=o?1:0;break;case i[2]:this.state.move.pitchDown=o?1:0;break;case i[3]:this.state.move.yawRight=o?1:0}this.updateRotationVector()}},_rollKeys:function(t,e){if(_.inArray("keys",this.options.monitor)){var o="keydown"==t.type,i=this._keys._rollKeys;switch(e){case i[0]:this.state.move.rollLeft=o?1:0;break;case i[1]:this.state.move.rollRight=o?1:0}this.updateRotationVector()}},_elevateKeys:function(t,e){if(_.inArray("keys",this.options.monitor)){var o="keydown"==t.type,i=this._keys._elevateKeys;switch(e){case i[0]:this.state.move.up=o?1:0;break;case i[1]:this.state.move.down=o?1:0}this.updateMovementVector()}},_accelerateKeys:function(t){if(_.inArray("keys",this.options.monitor)){var e="keydown"==t.type,o=this.movementSpeedMultiplier;this.movementSpeedMultiplier=e?10*o:o/10}},onMouseMove:function(t){if(_.inArray("mouse",this.options.monitor)){var e=this.getContainerDimensions(),o=e.size[0]/2,i=e.size[1]/2;this.state.move.yawLeft=-(t.pageX-e.offset[0]-o)/o,this.state.move.pitchDown=(t.pageY-e.offset[1]-i)/i,this.updateRotationVector()}},_updateControls:function(t){if(this.object)switch(this.options.controls){case"walk":this.updateControlsWalk(t);break;case"fly":this.updateControlsFly(t)}},updateControlsFly:function(t){var e=t.target,o=e.clock.getDelta(),i=o*this.options.moveStep,s=o*this.options.rotateStep;this.object.translateX(this.moveVector.x*i),this.object.translateY(this.moveVector.y*i),this.object.translateZ(this.moveVector.z*i),this.tmpQuaternion.set(this.rotationVector.x*s,this.rotationVector.y*s,this.rotationVector.z*s,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),this.object.rotation.setFromQuaternion(this.object.quaternion,this.object.rotation.order)},updateControlsWalk:function(t){var e=t.target,o=e.clock.getDelta(),i=o*this.options.moveStep,s=(o*this.options.rotateStep*2,this.object.position.y);this.object.translateX(this.moveVector.x*i),this.object.translateY(this.moveVector.y*i),this.object.translateZ(this.moveVector.z*i),this.object.position.y=s;var n=this.data.get("controls");n.lon-=this.rotationVector.y,n.lat+=this.rotationVector.x,n.lat=Math.max(-85,Math.min(85,n.lat));var a=THREE.Math.degToRad(90-n.lat),c=THREE.Math.degToRad(n.lon),r=new THREE.Vector3(0,0,0),h=this.object.position;r.x=h.x+100*Math.sin(a)*Math.cos(c),r.y=h.y+100*Math.cos(a),r.z=h.z+100*Math.sin(a)*Math.sin(c),this.object.lookAt(r),this.data.set({controls:n})},updateControlsFollow:function(){},updateControlsRotate:function(){},getContainerDimensions:function(){return{size:[window.innerWidth,window.innerHeight],offset:[0,0]}}})}function o(t,e){t=t||{},e=e||[];for(var i in t){var s=t[i];s instanceof THREE.Mesh?e.push(s):s.children&&(e=e.concat(o(s.children)))}return e}function i(){return"ontouchstart"in document&&!("callPhantom"in window)}"undefined"!=typeof construct&&(construct.input=function(t){return t=t||[],t.indexOf("keys")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.ui.keys"),construct.config.deps.push("backbone.ui.keys")),t.indexOf("mouse")>-1&&construct.config.deps.push("backbone.ui.mouse"),t.indexOf("touch")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.ui.touch"),construct.config.deps.push("backbone.ui.touch")),t.indexOf("gamepad")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.ui.gamepad"),construct.config.deps.push("backbone.ui.gamepad")),Object.extend(construct.options,{input:t}),function(){}},construct.config=Object.extend(construct.config,{paths:{"backbone.ui.keys":["//rawgithub.com/backbone-input/keys/master/build/backbone.input.keys"],"backbone.ui.touch":["//rawgithub.com/backbone-input/touch/master/build/backbone.input.touch"],"backbone.ui.mouse":["//rawgithub.com/backbone-input/mouse/master/build/backbone.input.mouse"],"backbone.ui.gamepad":["//rawgithub.com/backbone-input/gamepad/master/build/backbone.input.gamepad"]},shim:{"backbone.ui.keys":{deps:["backbone","underscore","jquery"]},"backbone.ui.touch":{deps:["backbone","underscore","jquery"]},"backbone.ui.mouse":{deps:["backbone","underscore","jquery"]}}}),_.mixin({inArray:_.inArray||function(t,e){return e.indexOf(t)>-1},inDebug:_.inDebug||function(){return"undefined"!=typeof DEBUG&&DEBUG}}),construct.promise.add(function(){t(),e()}))}();