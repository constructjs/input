!function(){function t(){var t=construct.options.input||[],e={};t.indexOf("keys")>-1,t.indexOf("mouse")>-1,t.indexOf("touch")>-1&&i()&&(e.click="_ontouch"),t.indexOf("gamepad")>-1;var n=APP.Views.Main3D;APP.Views.Main3D=n.extend({options:{monitor:construct.options.input},events:e,initialize:function(t){var e=this.options.monitorMove||_.inArray("mouse",this.options.monitor);return e&&this.on("intersect",_.bind(this.clickObject,this)),n.prototype.initialize.call(this,t)},_start:function(t){return t.projector=new THREE.Projector,n.prototype._start.call(this,t)},mousemove:function(t){var e=this.objects.get("player");e&&e.onMouseMove&&e.onMouseMove(t)},mousedown:function(){this.checkIntersect()},_ontouch:function(t){var e=t.originalEvent.changedTouches[0],o=e.clientX,i=e.clientY;this.params.set({mouse:{x:o,y:i}}),this.checkIntersect(),this.ontouch&&this.ontouch(t)},clickObject:function(t){console.log("clickObject:",t)},checkIntersect:function(){var t=$(this.el),e=t.offset(),i=this.params.get("mouse"),n=(i.x-e.left)/jQuery(window).width()*2-1,s=2*-((i.y-e.top)/jQuery(window).height())+1,a=.5,r=new THREE.Vector3(n,s,a),c=this.$3d.active.camera,h=o(this.$3d.objects);this.$3d.projector.unprojectVector(r,c);var u=new THREE.Raycaster(c.position,r.sub(c.position).normalize()),p=u.intersectObjects(h);if(p.length>0){var m=p[0].object.parent;this.trigger("intersect",m)}}})}function e(){var t=APP.Meshes.Player;APP.Meshes.Player=t.extend({keys:{"w a s d":"_moveKeys","up left down right":"_rotateKeys","q e":"_rollKeys","r f":"_elevateKeys",shift:"_accelerateKeys"},_start:function(e){return this.options.controls&&(this.on("update",_.bind(this._updateControls,this)),this.data.set({controls:{lon:0,lat:0}})),t.prototype._start.call(this,e)},onConnectGamepad:function(){},onDisconnectGamepad:function(){},updateGamepads:function(){var t=this.params.get("gamepads");if(t&&t[0]){var e=t[0].axes;this.state.move.left=e[0]<-.4?1:0,this.state.move.right=e[0]>.4?1:0,this.state.move.forward=e[1]<-.4?1:0,this.state.move.back=e[1]>.4?1:0,this.state.move.yawLeft=e[2]<-.4?1:0,this.state.move.yawRight=e[2]>.4?1:0,this.state.move.pitchUp=e[3]<-.4?1:0,this.state.move.pitchDown=e[3]>.4?1:0;var o=t[0].buttons;for(var i in o)if(o[i]){var n=this._buttonKey(i);this.trigger(n)}}this.updateMovementVector(),this.updateRotationVector()},_moveKeys:function(t,e){if(_.inArray("keys",this.options.monitor)){var o="keydown"==t.type,i=this._keys._moveKeys;switch(e){case i[0]:this.state.move.forward=o?1:0;break;case i[1]:this.state.move.left=o?1:0;break;case i[2]:this.state.move.back=o?1:0;break;case i[3]:this.state.move.right=o?1:0}this.updateMovementVector()}},_rotateKeys:function(t,e){if(_.inArray("keys",this.options.monitor)){var o="keydown"==t.type,i=this._keys._rotateKeys;switch(e){case i[0]:this.state.move.pitchUp=o?1:0;break;case i[1]:this.state.move.yawLeft=o?1:0;break;case i[2]:this.state.move.pitchDown=o?1:0;break;case i[3]:this.state.move.yawRight=o?1:0}this.updateRotationVector()}},_rollKeys:function(t,e){if(_.inArray("keys",this.options.monitor)){var o="keydown"==t.type,i=this._keys._rollKeys;switch(e){case i[0]:this.state.move.rollLeft=o?1:0;break;case i[1]:this.state.move.rollRight=o?1:0}this.updateRotationVector()}},_elevateKeys:function(t,e){if(_.inArray("keys",this.options.monitor)){var o="keydown"==t.type,i=this._keys._elevateKeys;switch(e){case i[0]:this.state.move.up=o?1:0;break;case i[1]:this.state.move.down=o?1:0}this.updateMovementVector()}},_accelerateKeys:function(t){if(_.inArray("keys",this.options.monitor)){var e="keydown"==t.type,o=this.movementSpeedMultiplier;this.movementSpeedMultiplier=e?10*o:o/10}},onMouseMove:function(t){if(_.inArray("mouse",this.options.monitor)){var e=this.getContainerDimensions(),o=e.size[0]/2,i=e.size[1]/2;this.state.move.yawLeft=-(t.pageX-e.offset[0]-o)/o,this.state.move.pitchDown=(t.pageY-e.offset[1]-i)/i,this.updateRotationVector()}},onMotionAccelerometer:function(){if(_.inArray("motion",this.options.monitor)&&_.inArray("accelerometer",this.options.states.motion)){var t=this.params.get("accelerometer"),e=this.getContainerDimensions(),o=(e.size[0]/2,e.size[1]/2,t.y>0?1:-1),i=Math.abs(t.y)<90?t.y:o*(180-Math.abs(t.y));this.state.move.yawLeft=-i/90;var n=t.z<0?1:-1;this.state.move.pitchDown=n*(1-Math.abs(t.z)/90),this.updateRotationVector()}},onOrientationUpdate:function(){if(_.inArray("motion",this.options.monitor)&&_.inArray("rift",this.options.states.motion)){var t=this.params.get("rift");this.tmpQuaternion=new THREE.Quaternion(t.x,t.y,t.z,t.w)}},_updateControls:function(t){if(this.object){var e=_.inArray("motion",this.options.monitor)&&_.inArray("rift",this.options.states.motion);switch(this.options.controls){case"walk":this.updateControlsWalk(t);break;case"fly":e?this.updateControlsFlyVR(t):this.updateControlsFly(t)}}},updateControlsFly:function(t){var e=t.target,o=e.clock.getDelta(),i=o*this.options.moveStep,n=o*this.options.rotateStep;this.object.translateX(this.moveVector.x*i),this.object.translateY(this.moveVector.y*i),this.object.translateZ(this.moveVector.z*i),this.tmpQuaternion.set(this.rotationVector.x*n,this.rotationVector.y*n,this.rotationVector.z*n,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),this.object.rotation.setFromQuaternion(this.object.quaternion,this.object.rotation.order)},updateControlsFlyVR:function(t){{var e=t.target,o=e.clock.getDelta(),i=o*this.options.moveStep;o*this.options.rotateStep}this.object.translateX(this.moveVector.x*i),this.object.translateY(this.moveVector.y*i),this.object.translateZ(this.moveVector.z*i),this.object.quaternion.set(this.tmpQuaternion.x,this.tmpQuaternion.y,this.tmpQuaternion.z,this.tmpQuaternion.w),this.object.rotation.setFromQuaternion(this.object.quaternion,this.object.rotation.order)},updateControlsWalk:function(t){var e=t.target,o=e.clock.getDelta(),i=o*this.options.moveStep,n=(o*this.options.rotateStep*2,this.object.position.y);this.object.translateX(this.moveVector.x*i),this.object.translateY(this.moveVector.y*i),this.object.translateZ(this.moveVector.z*i),this.object.position.y=n;var s=this.data.get("controls");s.lon-=this.rotationVector.y,s.lat+=this.rotationVector.x,s.lat=Math.max(-85,Math.min(85,s.lat));var a=THREE.Math.degToRad(90-s.lat),r=THREE.Math.degToRad(s.lon),c=new THREE.Vector3(0,0,0),h=this.object.position;c.x=h.x+100*Math.sin(a)*Math.cos(r),c.y=h.y+100*Math.cos(a),c.z=h.z+100*Math.sin(a)*Math.sin(r),this.object.lookAt(c),this.data.set({controls:s})},updateControlsFollow:function(){},updateControlsRotate:function(){},getContainerDimensions:function(){return{size:[window.innerWidth,window.innerHeight],offset:[0,0]}}})}function o(t,e){t=t||{},e=e||[];for(var i in t){var n=t[i];n instanceof THREE.Mesh?e.push(n):n.children&&(e=e.concat(o(n.children)))}return e}function i(){return"ontouchstart"in document&&!("callPhantom"in window)}"undefined"!=typeof construct&&(construct.input=function(t){return t=t||[],t.indexOf("keys")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.input.keys"),construct.config.deps.push("backbone.input.keys")),t.indexOf("mouse")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.input.mouse"),construct.config.deps.push("backbone.input.mouse")),t.indexOf("touch")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.input.touch"),construct.config.deps.push("backbone.input.touch")),t.indexOf("gamepad")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.input.gamepad"),construct.config.deps.push("backbone.input.gamepad")),t.indexOf("motion")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.input.motion"),construct.config.deps.push("backbone.input.motion")),Object.extend(construct.options,{input:t}),function(){}},construct.config=Object.extend(construct.config,{paths:{"backbone.input.keys":["//rawgithub.com/backbone-input/keys/master/build/backbone.input.keys"],"backbone.input.touch":["//rawgithub.com/backbone-input/touch/master/build/backbone.input.touch"],"backbone.input.mouse":["//rawgithub.com/backbone-input/mouse/master/build/backbone.input.mouse"],"backbone.input.gamepad":["//rawgithub.com/backbone-input/gamepad/master/build/backbone.input.gamepad"],"backbone.input.motion":["//rawgithub.com/backbone-input/motion/master/build/backbone.input.motion"]},shim:{"backbone.input.keys":{deps:["backbone","underscore","jquery"]},"backbone.input.touch":{deps:["backbone","underscore","jquery"]},"backbone.input.mouse":{deps:["backbone","underscore","jquery"]},"backbone.input.motion":{deps:["backbone","underscore","jquery"]}}}),_.mixin({inArray:_.inArray||function(t,e){return e.indexOf(t)>-1},inDebug:_.inDebug||function(){return"undefined"!=typeof DEBUG&&DEBUG}}),construct.promise.add(function(){t(),e()}))}();