!function(t){"function"==typeof define&&define.amd?define(["jquery","underscore","backbone"],t):t($,_,Backbone)}(function(t,e){function o(t,e){t=t||{},e=e||[];for(var i in t){var n=t[i];n instanceof THREE.Mesh?e.push(n):n.children&&(e=e.concat(o(n.children)))}return e}function i(){return"ontouchstart"in document&&!("callPhantom"in window)}function n(){var n=construct.options.input||[],s={};n.indexOf("keys")>-1,n.indexOf("mouse")>-1,n.indexOf("touch")>-1&&i()&&(s.click="_ontouch"),n.indexOf("gamepad")>-1;var a=APP.Views.Main3D;APP.Views.Main3D=a.extend({options:{monitor:construct.options.input},events:s,keys:{f2:"_clickPause"},initialize:function(t){var o=this.options.monitorMove||e.inArray("mouse",this.options.monitor);return o&&this.on("intersect",e.bind(this.clickObject,this)),a.prototype.initialize.call(this,t)},_start:function(t){return t.projector=new THREE.Projector,a.prototype._start.call(this,t)},mousemove:function(t){var e=this.objects.get("player");e&&e.onMouseMove&&e.onMouseMove(t)},mousedown:function(){this.checkIntersect()},_ontouch:function(t){var e=t.originalEvent.changedTouches[0],o=e.clientX,i=e.clientY;this.params.set({mouse:{x:o,y:i}}),this.checkIntersect(),this.ontouch&&this.ontouch(t)},clickObject:function(t){console.log("clickObject:",t)},checkIntersect:function(){var e=t(this.el),i=e.offset(),n=this.params.get("mouse"),s=(n.x-i.left)/jQuery(window).width()*2-1,a=2*-((n.y-i.top)/jQuery(window).height())+1,r=.5,c=new THREE.Vector3(s,a,r),u=this.$3d.active.camera,h=o(this.$3d.objects);this.$3d.projector.unprojectVector(c,u);var p=new THREE.Raycaster(u.position,c.sub(u.position).normalize()),m=p.intersectObjects(h);if(m.length>0){var b=m[0].object.parent;this.trigger("intersect",b)}},clickPause:function(){},_clickPause:function(t){"keyup"!=t.type&&(this.clickPause(t),this.trigger("pause",t))}})}function s(){var t=APP.Meshes.Player;APP.Meshes.Player=t.extend({keys:{"w a s d":"_moveKeys","up left down right":"_rotateKeys","q e":"_rollKeys","r f":"_elevateKeys",shift:"_accelerateKeys"},_start:function(o){return e.bindAll(this,"updateData"),this.options.controls&&(this.on("update",e.bind(this._updateControls,this)),this.data.set({controls:{lon:0,lat:0}})),this.on("gamepadButton",e.bind(this.onGamepadButton,this)),t.prototype._start.call(this,o)},_clickPause:function(t){this.trigger("pause",t)},onConnectGamepad:function(){},onDisconnectGamepad:function(){},updateGamepads:function(){var t=this.params.get("gamepads");if(t&&t[0]){var e=t[0].axes;this.state.move.left=e[0]<-.4?1:0,this.state.move.right=e[0]>.4?1:0,this.state.move.forward=e[1]<-.4?1:0,this.state.move.back=e[1]>.4?1:0,this.state.move.yawLeft=e[2]<-.4?1:0,this.state.move.yawRight=e[2]>.4?1:0,this.state.move.pitchUp=e[3]<-.4?1:0,this.state.move.pitchDown=e[3]>.4?1:0;var o=t[0].buttons,i=[];for(var n in o)if(o[n].value){var s=this._buttonKey(n);i.push(s)}i.length?this.trigger("gamepadButton",{buttons:i}):this.state.set({gamepadButtons:[]})}this.updateMovementVector(),this.updateRotationVector()},onGamepadButton:function(t){var e=t.buttons,o=this.state.get("gamepadButtons");for(var i in e)"Start"==e[i]&&-1==o.indexOf("Start")&&this._clickPause(t);this.state.set("gamepadButtons",e)},_moveKeys:function(t,o){if(e.inArray("keys",this.options.monitor)){var i="keydown"==t.type,n=this._keys._moveKeys,s=this.options.keys.pause||[];switch(o){case n[0]:this.state.move.forward=i&&!e.inArray(o,s)?1:0;break;case n[1]:this.state.move.left=i&&!e.inArray(o,s)?1:0;break;case n[2]:this.state.move.back=i&&!e.inArray(o,s)?1:0;break;case n[3]:this.state.move.right=i&&!e.inArray(o,s)?1:0}this.updateMovementVector()}},_rotateKeys:function(t,o){if(e.inArray("keys",this.options.monitor)){var i="keydown"==t.type,n=this._keys._rotateKeys,s=this.options.keys.pause||[];switch(o){case n[0]:this.state.move.pitchUp=i&&!e.inArray(o,s)?1:0;break;case n[1]:this.state.move.yawLeft=i&&!e.inArray(o,s)?1:0;break;case n[2]:this.state.move.pitchDown=i&&!e.inArray(o,s)?1:0;break;case n[3]:this.state.move.yawRight=i&&!e.inArray(o,s)?1:0}this.updateRotationVector()}},_rollKeys:function(t,o){if(e.inArray("keys",this.options.monitor)){var i="keydown"==t.type,n=this._keys._rollKeys;switch(o){case n[0]:this.state.move.rollLeft=i?1:0;break;case n[1]:this.state.move.rollRight=i?1:0}this.updateRotationVector()}},_elevateKeys:function(t,o){if(e.inArray("keys",this.options.monitor)){var i="keydown"==t.type,n=this._keys._elevateKeys;switch(o){case n[0]:this.state.move.up=i?1:0;break;case n[1]:this.state.move.down=i?1:0}this.updateMovementVector()}},_accelerateKeys:function(t){if(e.inArray("keys",this.options.monitor)){var o="keydown"==t.type,i=this.movementSpeedMultiplier;this.movementSpeedMultiplier=o?10*i:i/10}},onMouseMove:function(t){if(e.inArray("mouse",this.options.monitor)){var o=this.getContainerDimensions(),i=o.size[0]/2,n=o.size[1]/2;this.state.move.yawLeft=-(t.pageX-o.offset[0]-i)/i,this.state.move.pitchDown=(t.pageY-o.offset[1]-n)/n,this.updateRotationVector()}},onMotionAccelerometer:function(){if(e.inArray("motion",this.options.monitor)&&e.inArray("accelerometer",this.options.states.motion)){var t=this.params.get("accelerometer"),o=this.getContainerDimensions(),i=(o.size[0]/2,o.size[1]/2,t.y>0?1:-1),n=Math.abs(t.y)<90?t.y:i*(180-Math.abs(t.y));this.state.move.yawLeft=-n/90;var s=t.z<0?1:-1;this.state.move.pitchDown=s*(1-Math.abs(t.z)/90),this.updateRotationVector()}},onOrientationUpdate:function(){if(e.inArray("motion",this.options.monitor)&&e.inArray("rift",this.options.states.motion)){var t=this.params.get("rift");this.tmpQuaternion=new THREE.Quaternion(t.x,t.y,t.z,t.w)}},_updateControls:function(t){if(this.object){var o=e.inArray("motion",this.options.monitor)&&e.inArray("rift",this.options.states.motion);switch(this.options.controls){case"walk":this.updateControlsWalk(t);break;case"fly":o?this.updateControlsFlyVR(t):this.updateControlsFly(t)}}},updateControlsFly:function(t){var e=t.target,o=e.clock.getDelta(),i=o*this.options.moveStep,n=o*this.options.rotateStep;this.object.translateX(this.moveVector.x*i),this.object.translateY(this.moveVector.y*i),this.object.translateZ(this.moveVector.z*i),this.tmpQuaternion.set(this.rotationVector.x*n,this.rotationVector.y*n,this.rotationVector.z*n,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),this.object.rotation.setFromQuaternion(this.object.quaternion,this.object.rotation.order),this.updateData(["position","rotation"])},updateControlsFlyVR:function(t){{var e=t.target,o=e.clock.getDelta(),i=o*this.options.moveStep;o*this.options.rotateStep}this.object.translateX(this.moveVector.x*i),this.object.translateY(this.moveVector.y*i),this.object.translateZ(this.moveVector.z*i),this.object.quaternion.set(this.tmpQuaternion.x,this.tmpQuaternion.y,this.tmpQuaternion.z,this.tmpQuaternion.w),this.object.rotation.setFromQuaternion(this.object.quaternion,this.object.rotation.order),this.updateData(["position","rotation"])},updateControlsWalk:function(t){var e=t.target,o=e.clock.getDelta(),i=o*this.options.moveStep,n=(o*this.options.rotateStep*2,this.object.position.y);this.object.translateX(this.moveVector.x*i),this.object.translateY(this.moveVector.y*i),this.object.translateZ(this.moveVector.z*i),this.object.position.y=n;var s=this.data.get("controls");s.lon-=this.rotationVector.y,s.lat+=this.rotationVector.x,s.lat=Math.max(-85,Math.min(85,s.lat));var a=THREE.Math.degToRad(90-s.lat),r=THREE.Math.degToRad(s.lon),c=new THREE.Vector3(0,0,0),u=this.object.position;c.x=u.x+100*Math.sin(a)*Math.cos(r),c.y=u.y+100*Math.cos(a),c.z=u.z+100*Math.sin(a)*Math.sin(r),this.object.lookAt(c),this.data.set({controls:s}),this.updateData(["position","rotation"])},updateControlsFollow:function(){},updateControlsRotate:function(){},updateData:function(t){t=t||[],t instanceof Array||(t=[t]);var e={};for(var o in t){var i=t[o];if(this.object[i]){var n=this.object[i];e[i]=[n.x,n.y,n.z]}}this.data.set(e)},getContainerDimensions:function(){return{size:[window.innerWidth,window.innerHeight],offset:[0,0]}}})}"undefined"!=typeof construct&&(e.mixin({inArray:e.inArray||function(t,e){return e.indexOf(t)>-1},inDebug:e.inDebug||function(){return"undefined"!=typeof DEBUG&&DEBUG}}),construct.input=function(e){return e=e||[],e.indexOf("keys")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.input.keys"),construct.config.deps.push("backbone.input.keys")),e.indexOf("mouse")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.input.mouse"),construct.config.deps.push("backbone.input.mouse")),e.indexOf("touch")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.input.touch"),construct.config.deps.push("backbone.input.touch")),e.indexOf("gamepad")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.input.gamepad"),construct.config.deps.push("backbone.input.gamepad")),e.indexOf("motion")>-1&&(construct.config.shim["backbone.app"].deps.push("backbone.input.motion"),construct.config.deps.push("backbone.input.motion")),t.extend({},construct.options,{input:e}),function(){}},construct.config=t.extend({},construct.config,{paths:{"backbone.input.keys":["//rawgit.com/backbone-input/keys/master/build/backbone.input.keys"],"backbone.input.touch":["//rawgit.com/backbone-input/touch/master/build/backbone.input.touch"],"backbone.input.mouse":["//rawgit.com/backbone-input/mouse/master/build/backbone.input.mouse"],"backbone.input.gamepad":["//rawgit.com/backbone-input/gamepad/master/build/backbone.input.gamepad"],"backbone.input.motion":["//rawgit.com/backbone-input/motion/master/build/backbone.input.motion"]},shim:{"backbone.input.keys":{deps:["backbone","underscore","jquery"]},"backbone.input.touch":{deps:["backbone","underscore","jquery"]},"backbone.input.mouse":{deps:["backbone","underscore","jquery"]},"backbone.input.motion":{deps:["backbone","underscore","jquery"]}}}),construct.promise.add(function(){n(),s()}))});